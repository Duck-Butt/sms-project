<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ë™ê³  AI ë„ìš°ë¯¸</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* ëŒ€í™”ì°½ ê³ ì • ë†’ì´ ë° ìŠ¤í¬ë¡¤ ì„¤ì • */
        #chat-container {
            max-height: 70vh; /* ë·°í¬íŠ¸ ë†’ì´ì˜ 70% */
            overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹  ë•Œë§Œ ìŠ¤í¬ë¡¤ í‘œì‹œ */
            scroll-behavior: smooth; /* ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ íš¨ê³¼ */
        }
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background-color: #90b8f8;
            border-radius: 3px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <!-- ë©”ì¸ ì±—ë´‡ ì¹´ë“œ -->
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 flex flex-col h-[85vh]">
        
        <!-- í—¤ë” -->
        <header class="mb-4 pb-3 border-b border-blue-100">
            <h1 class="text-2xl font-bold text-blue-700">ì‚¬ë™ê³  AI ë„ìš°ë¯¸ ë´‡ ğŸ¤–</h1>
            <p class="text-sm text-gray-500">í•™êµ ì •ë³´, ê¸‰ì‹ ì •ë³´ ë“± ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”! (í˜„ì¬ ë§íˆ¬: <span id="current-style-display" class="font-bold text-blue-500">ì¼ë°˜ ì¡´ëŒ“ë§</span>)</p>
        </header>

        <!-- ëŒ€í™” ê¸°ë¡ ì˜ì—­ -->
        <div id="chat-container" class="flex-grow space-y-4 pr-2">
            <!-- ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ -->
            <div class="flex justify-start">
                <div class="max-w-xs md:max-w-md bg-blue-100 text-gray-800 p-3 rounded-xl rounded-tl-none shadow-md">
                    <p class="font-semibold text-blue-800 mb-1">AI ë„ìš°ë¯¸</p>
                    <p>ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì‚¬ë™ê³  AI ë„ìš°ë¯¸ì…ë‹ˆë‹¤. í•™êµì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¼ì–´ë³´ì„¸ìš”! ğŸ˜Š</p>
                </div>
            </div>
            <!-- ë©”ì‹œì§€ ê¸°ë¡ì€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <footer class="mt-6 pt-4 border-t border-gray-200">
            <div class="flex flex-wrap items-center space-x-2 mb-3">
                <label for="style-select" class="text-sm font-medium text-gray-700 self-center">ë§íˆ¬ ì„ íƒ:</label>
                <!-- 4ê°€ì§€ ë§íˆ¬ ì˜µì…˜ -->
                <select id="style-select" class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    <option value="ì¡´ëŒ“ë§" selected>ì¼ë°˜</option>
                    <option value="ì¹œêµ¬">ì¹œêµ¬</option>
                    <option value="ì„ ë°°">ì„ ë°°</option>
                    <option value="ì„ ìƒë‹˜">ì„ ìƒë‹˜</option>
                </select>
            </div>
            <div class="flex space-x-3">
                <input 
                    type="text" 
                    id="user-input" 
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                    class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-50"
                    onkeypress="if(event.key === 'Enter') sendMessage()"
                >
                <button 
                    onclick="sendMessage()" 
                    id="send-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-xl transition duration-200 shadow-lg active:scale-95 disabled:bg-gray-400 disabled:shadow-none"
                >
                    ì „ì†¡
                </button>
            </div>
        </footer>
    </div>

    <!-- JavaScript ë¡œì§ -->
    <script>
        // DOM ìš”ì†Œ ì •ì˜
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const styleSelect = document.getElementById('style-select');
        const currentStyleDisplay = document.getElementById('current-style-display');

        // ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
        const COOLDOWN_SECONDS = 5; // ë§íˆ¬ ë³€ê²½ ì¿¨ë‹¤ìš´ (5ì´ˆ)
        let lastStyleChangeTime = 0; // ë§ˆì§€ë§‰ ë³€ê²½ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        let currentStyle = 'ì¡´ëŒ“ë§'; // í˜„ì¬ ì ìš© ì¤‘ì¸ ë§íˆ¬ (ì´ˆê¸°ê°’)

        // 1. API Endpoint ì„¤ì •: ì§ì ‘ Gemini API ëŒ€ì‹  Flask ì„œë²„ì˜ ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
        // ì´ì œ ì„œë²„ê°€ ëª¨ë“  API í‚¤ ê´€ë¦¬ì™€ ë°ì´í„° ì£¼ì…ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
        const API_URL = '/api/chat'; 
        
        // 2. TONE_MAPPING, SCHOOL_INFO, DATA_STRING ë³€ìˆ˜ëŠ” ì„œë²„ë¡œì§ìœ¼ë¡œ ì´ë™í•˜ì—¬ ì‚­ì œí•©ë‹ˆë‹¤.

        /**
         * ëŒ€í™” ê¸°ë¡ ì˜ì—­ì„ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤.
         */
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ëŒ€í™”ì°½ì— ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        function appendMessage(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-xs md:max-w-md p-3 rounded-xl shadow-lg transition-all duration-300 ${
                sender === 'user' 
                    ? 'bg-blue-600 text-white rounded-br-none' 
                    : 'bg-gray-200 text-gray-800 rounded-tl-none'
            }`;

            if (sender === 'ai') {
                const senderName = document.createElement('p');
                senderName.className = 'font-semibold text-blue-700 mb-1';
                senderName.textContent = 'AI ë„ìš°ë¯¸';
                messageBubble.appendChild(senderName);
            }

            const messageText = document.createElement('p');
            // í…ìŠ¤íŠ¸ë¥¼ HTML í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
            messageText.innerHTML = text; 
            messageBubble.appendChild(messageText);
            
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            
            scrollToBottom();
            return messageBubble;
        }

        /**
         * ì‹œìŠ¤í…œ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ì¤‘ì•™ì— ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        function appendSystemMessage(text, type = 'info') {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex justify-center w-full my-2`;
            
            let colorClass = 'bg-gray-100 text-gray-600';
            if (type === 'success') colorClass = 'bg-green-100 text-green-700 font-medium';
            if (type === 'error') colorClass = 'bg-red-100 text-red-700 font-medium';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `text-xs py-1 px-3 rounded-full shadow-sm ${colorClass}`;
            messageBubble.textContent = text;
            
            messageWrapper.appendChild(messageBubble);
            chatContainer.appendChild(messageWrapper);
            scrollToBottom();
        }

        /**
         * ë§íˆ¬ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬: ì¿¨ë‹¤ìš´ì„ í™•ì¸í•˜ê³  ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function handleStyleChange() {
            const now = Date.now();
            const newStyle = styleSelect.value;
            const cooldownEndTime = lastStyleChangeTime + COOLDOWN_SECONDS * 1000;

            // ì´ë¯¸ í˜„ì¬ ìŠ¤íƒ€ì¼ë¡œ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
            if (newStyle === currentStyle) return;

            // ì¿¨ë‹¤ìš´ ì²´í¬
            if (now < cooldownEndTime) {
                const remaining = Math.ceil((cooldownEndTime - now) / 1000);
                
                // í˜„ì¬ ìœ íš¨í•œ ìŠ¤íƒ€ì¼ë¡œ select ë°•ìŠ¤ ë˜ëŒë¦¬ê¸°
                styleSelect.value = currentStyle;

                appendSystemMessage(`âŒ [ë§íˆ¬ ë³€ê²½ ì‹¤íŒ¨] ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! ë§íˆ¬ëŠ” ${COOLDOWN_SECONDS}ì´ˆì— í•œ ë²ˆë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (${remaining}ì´ˆ ë‚¨ìŒ)`, 'error');
                return;
            }

            // ì„±ê³µ: ìŠ¤íƒ€ì¼ ë° ì‹œê°„ ì—…ë°ì´íŠ¸
            const previousStyle = currentStyle;
            currentStyle = newStyle;
            lastStyleChangeTime = now;
            
            // í™•ì¸ ë©”ì‹œì§€ í‘œì‹œ ë° í—¤ë” ì—…ë°ì´íŠ¸
            const newStyleName = styleSelect.options[styleSelect.selectedIndex].text;
            const prevStyleName = Array.from(styleSelect.options).find(opt => opt.value === previousStyle).text;

            currentStyleDisplay.textContent = newStyleName;
            appendSystemMessage(`âœ… [ë§íˆ¬ ë³€ê²½ ì™„ë£Œ] ì±—ë´‡ì˜ ë§íˆ¬ê°€ '${prevStyleName}'ì—ì„œ '${newStyleName}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // ë§íˆ¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        styleSelect.addEventListener('change', handleStyleChange);


        /**
         * Flask ì„œë²„ì˜ /api/chat ì—”ë“œí¬ì¸íŠ¸ë¥¼ í˜¸ì¶œí•˜ì—¬ ë‹µë³€ì„ ìƒì„±í•˜ê³ , ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.
         */
        async function getChatbotResponse(user_query, style, loadingBubble) {
            // Flask ì„œë²„ê°€ í•„ìš”í•œ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” queryì™€ styleë§Œ ë³´ëƒ…ë‹ˆë‹¤.
            const payload = {
                query: user_query,
                style: style,
            };

            const maxRetries = 5;
            let initialDelay = 1000; // 1ì´ˆ

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            throw new Error('429 Rate Limit Exceeded (Retrying)');
                        }
                        
                        // ì„œë²„ì—ì„œ ë°˜í™˜í•˜ëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í¬í•¨í•˜ì—¬ ìƒì„¸ ì˜¤ë¥˜ ì¶œë ¥
                        let errorDetails = await response.text();
                        try {
                            errorDetails = JSON.parse(errorDetails).error || errorDetails;
                        } catch(e) {
                            // Not a JSON error, use raw text
                        }
                        throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${response.status}): ${errorDetails}`);
                    }

                    const result = await response.json();
                    // Flask ì„œë²„ëŠ” 'response' í‚¤ì— ìµœì¢… í…ìŠ¤íŠ¸ë¥¼ ë‹´ì•„ ë³´ëƒ…ë‹ˆë‹¤.
                    const aiText = result.response; 

                    if (!aiText) {
                        throw new Error('ì„œë²„ì—ì„œ ìœ íš¨í•œ ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    return aiText; // ì„±ê³µ ì‹œ í…ìŠ¤íŠ¸ ë°˜í™˜

                } catch (e) {
                    console.error(`API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ì‹œë„ ${i + 1}/${maxRetries}):`, e);

                    if (i < maxRetries - 1) {
                        const delay = initialDelay * (2 ** i) + Math.random() * 500; // ì§€ìˆ˜ ë°±ì˜¤í”„ + ëœë¤ ì§€í„°
                        // ë¡œë”© ë©”ì‹œì§€ì— ì¬ì‹œë„ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸
                        if(loadingBubble.parentElement) { 
                            loadingBubble.querySelector('p:not(.font-semibold)').innerHTML = `ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨. ${Math.ceil(delay/1000)}ì´ˆ í›„ ì¬ì‹œë„...`;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼: ${e.message}`);
                    }
                }
            }
        }


        /**
         * ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ê³  ì±—ë´‡ ì‘ë‹µì„ ë°›ìŠµë‹ˆë‹¤.
         */
        async function sendMessage() {
            const query = userInput.value.trim();
            // í˜„ì¬ ì ìš© ì¤‘ì¸ ìŠ¤íƒ€ì¼(currentStyle) ì‚¬ìš©
            const style = currentStyle; 
            if (query === '') return;

            // 1. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¦‰ì‹œ ì¶”ê°€
            appendMessage('user', query);
            userInput.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            
            // 2. ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€ ë° ë²„íŠ¼/ì…ë ¥ ë¹„í™œì„±í™”
            sendButton.disabled = true;
            userInput.disabled = true;
            styleSelect.disabled = true; // ë§íˆ¬ ë³€ê²½ë„ ë¹„í™œì„±í™”
            const loadingBubble = appendMessage('ai', 'ì„œë²„ì— ìš”ì²­ í›„ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ğŸ’¬');
            
            // ë¡œë”© ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ìš”ì†Œ ì°¾ê¸° (ì—…ë°ì´íŠ¸ìš©)
            const loadingTextElement = loadingBubble.querySelector('p:not(.font-semibold)');

            try {
                // 3. API ìš”ì²­ ë° ì‘ë‹µ ë°›ê¸°
                const aiResponse = await getChatbotResponse(query, style, loadingBubble);
                
                // 4. ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ë¡œë”© ë²„ë¸”ì— ì‚½ì…í•˜ê³  HTML í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
                const aiResponseText = aiResponse.replace(/\n/g, '<br>');
                
                if (loadingTextElement) {
                    loadingTextElement.innerHTML = aiResponseText;
                } else {
                    loadingBubble.innerHTML = '<p class="font-semibold text-blue-700 mb-1">AI ë„ìš°ë¯¸</p>' + `<p>${aiResponseText}</p>`;
                }

            } catch (error) {
                console.error('ìµœì¢… ì˜¤ë¥˜ ë°œìƒ:', error);
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë¡œë”© ë²„ë¸”ì— í‘œì‹œ
                const errorText = `ì˜¤ë¥˜ ë°œìƒ: ${error.message.replace(/Error: /, '')}`;
                if (loadingTextElement) {
                     loadingTextElement.innerHTML = `<span class="text-red-500">${errorText}</span>`;
                } else {
                    loadingBubble.innerHTML = '<p class="font-semibold text-red-500 mb-1">AI ë„ìš°ë¯¸</p>' + `<p><span class="text-red-500">${errorText}</span></p>`;
                }
            } finally {
                // 5. ë²„íŠ¼/ì…ë ¥ ë‹¤ì‹œ í™œì„±í™” ë° ìŠ¤í¬ë¡¤
                sendButton.disabled = false;
                userInput.disabled = false;
                styleSelect.disabled = false; // ë§íˆ¬ ë³€ê²½ ë‹¤ì‹œ í™œì„±í™”
                userInput.focus(); // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                scrollToBottom();
            }
        }

        // ì´ˆê¸° ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì„¤ì • ë° í˜„ì¬ ìŠ¤íƒ€ì¼ í‘œì‹œ ì—…ë°ì´íŠ¸
        window.onload = () => {
            // ì´ˆê¸° ë¡œë“œ ì‹œ ì„ íƒëœ ì˜µì…˜ì˜ ì´ë¦„ìœ¼ë¡œ í—¤ë” ì—…ë°ì´íŠ¸
            const selectedOptionText = styleSelect.options[styleSelect.selectedIndex].text;
            currentStyle = styleSelect.value;
            currentStyleDisplay.textContent = selectedOptionText;
            scrollToBottom();
        }
    </script>
</body>
</html>
